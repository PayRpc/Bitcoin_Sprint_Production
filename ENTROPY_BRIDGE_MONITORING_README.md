# Entropy Bridge Monitoring Setup

This document explains how to monitor the dynamic admin authentication entropy bridge system using Prometheus and Grafana.

## Overview

The entropy bridge monitoring system provides real-time visibility into:

- **Entropy Source Status**: Whether Rust FFI, Node.js crypto, or environment variables are active
- **Secret Generation Metrics**: Performance and frequency of admin secret generation
- **System Health**: Availability and error rates of the entropy bridge

## Architecture

```text
Next.js Application (Port 3002)
├── /api/prometheus → Prometheus metrics endpoint
├── /api/admin/entropy-status → Entropy bridge status
└── /api/admin/test → Admin authentication test

Go Metrics Server (Port 8081)
├── /metrics → Combined Prometheus metrics
└── Fetches entropy status from Next.js

Prometheus (Port 9090)
└── Scrapes metrics from Go server

Grafana (Port 3000)
└── Visualizes metrics from Prometheus
```

## Setup Instructions

### 1. Start the Services

Ensure all services are running:

```bash
# Start Next.js application
cd web && npm run dev

# Start Go metrics server
go run metrics_server.go

# Start Prometheus (if not already running)
# Start Grafana (if not already running)
```

### 2. Verify Metrics Endpoints

Test the metrics endpoints:

```bash
# Next.js Prometheus metrics
curl http://localhost:3002/api/prometheus

# Next.js entropy bridge status
curl http://localhost:3002/api/admin/entropy-status

# Go combined metrics
curl http://localhost:8081/metrics
```

### 3. Configure Prometheus

Ensure Prometheus is configured to scrape the Go metrics server:

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'bitcoin-sprint'
    static_configs:
      - targets: ['localhost:8081']
```

### 4. Import Grafana Dashboard

1. Open Grafana at <http://localhost:3000>
2. Go to Dashboards → Import
3. Upload the `grafana-dashboard-entropy-bridge.json` file
4. Select your Prometheus data source

## Metrics Explained

### Entropy Bridge Status Metrics

- `bitcoin_sprint_entropy_bridge_available`: Overall bridge availability (1=available, 0=unavailable)
- `bitcoin_sprint_entropy_bridge_rust_available`: Rust FFI availability (1=available, 0=fallback)
- `bitcoin_sprint_entropy_bridge_fallback_mode`: Fallback mode status (1=active, 0=primary)

### Secret Generation Metrics

- `bitcoin_sprint_entropy_bridge_secret_generation_total`: Total secrets generated by source
  - Labels: `source` (rust/nodejs/env), `encoding` (base64/hex/raw)
- `bitcoin_sprint_entropy_bridge_secret_generation_duration_seconds`: Secret generation duration
- `bitcoin_sprint_entropy_bridge_last_secret_generated_timestamp`: Last secret generation time

### System Health Metrics

- `bitcoin_sprint_entropy_bridge_status_fetch_total`: Total status fetch attempts
- `bitcoin_sprint_entropy_bridge_status_fetch_errors_total`: Status fetch errors

## Monitoring Scenarios

### Normal Operation (Rust Available)

- ✅ Bridge Available: 1
- ✅ Rust Available: 1
- ✅ Fallback Mode: 0
- 📊 Secret Generation: Primarily from `rust` source

### Fallback Operation (Rust Unavailable)

- ✅ Bridge Available: 1
- ❌ Rust Available: 0
- ⚠️ Fallback Mode: 1
- 📊 Secret Generation: From `nodejs` source

### Error State

- ❌ Bridge Available: 0
- ❌ Rust Available: 0
- ⚠️ Fallback Mode: 1
- 📊 Secret Generation: From `env` source (if available)

## Troubleshooting

### Metrics Not Appearing

1. Check service status:
   ```bash
   curl http://localhost:3002/api/admin/entropy-status
   curl http://localhost:8081/metrics
   ```

2. Verify Prometheus targets:

   - Visit <http://localhost:9090/targets>
   - Ensure `bitcoin-sprint` target is UP

3. Check Grafana data source:
   - Test connection to Prometheus
   - Verify metric names match dashboard queries

### High Error Rates

- Check Next.js application logs for entropy bridge errors
- Verify network connectivity between Go server and Next.js
- Ensure FFI modules are properly installed (if using Rust)

### Performance Issues

- Monitor `bitcoin_sprint_entropy_bridge_secret_generation_duration_seconds`
- Check for high latency in secret generation
- Verify system resources (CPU, memory) are adequate

## Alerting Recommendations

Create alerts for:

1. **Entropy Bridge Unavailable**

   ```promql
   bitcoin_sprint_entropy_bridge_available == 0
   ```

2. **Rust Fallback Active**

   ```promql
   bitcoin_sprint_entropy_bridge_fallback_mode == 1
   ```

3. **High Error Rate**

   ```promql
   rate(bitcoin_sprint_entropy_bridge_status_fetch_errors_total[5m]) > 0.1
   ```

4. **Secret Generation Slow**

   ```promql
   bitcoin_sprint_entropy_bridge_secret_generation_duration_seconds{quantile="0.95"} > 1
   ```

## Security Considerations

- Entropy bridge status endpoint requires admin authentication
- Metrics do not expose actual secret values
- Monitor for unauthorized access attempts
- Regular security audits of the monitoring pipeline

## Integration with Existing Monitoring

The entropy bridge metrics integrate seamlessly with existing Bitcoin Sprint monitoring:

- **System Health**: Combined with existing health checks
- **Performance**: Added to existing performance dashboards
- **Security**: Part of comprehensive security monitoring suite

This monitoring system ensures you always know which entropy source is active and can quickly identify any issues with the dynamic admin authentication system.
